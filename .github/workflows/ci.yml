# GitHub Actions CI for DM Global Tur
# ENGLISH / ESPAÃ‘OL / ESPERANTO

name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dbname
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    env:
      DATABASE_URL: postgresql+asyncpg://user:password@localhost:5432/dbname
      API_KEY: changeme
      API_BASE_URL: http://localhost:8000
      GEMINI_API_KEY: dummy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies (backend)
        run: |
          pip install -r requirements-backend.txt
          pip install -r requirements.txt
      - name: Run Alembic migrations
        run: alembic upgrade head
      - name: Start FastAPI (background)
        run: uvicorn main:app --host 0.0.0.0 --port 8000 &
      - name: Wait for API
        run: sleep 5
      - name: Run API tests
        run: pytest tests/test_api_fastapi.py
      - name: Run Scraper tests
        run: pytest tests/test_scraper_playwright.py
